{% extends 'base.html' %}
{% load static %}

{% block styles %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" />
{% endblock %}

{% block content %}
  <main>
    <div class="courses starting-block">
      <div class="section-wrapp">
        <div class="spec-container">
          <div class="course-wrapper">
            <div class="course-heading">
              <h1 class="block-header section-heading">Kurslar</h1>
              <form action="" class="blocky-form">
                <input type="text" class="searching-input" placeholder="SAT kurs" />
                <span class="filter-opener">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3.48596 18.6941V1.93652C3.48596 1.73122 3.4044 1.53432 3.25923 1.38914C3.11405 1.24397 2.91715 1.16241 2.71184 1.16241C2.50654 1.16241 2.30964 1.24397 2.16446 1.38914C2.01929 1.53432 1.93773 1.73122 1.93773 1.93652V18.6941C1.31406 18.8801 0.778149 19.2843 0.428004 19.8329C0.0778598 20.3815 -0.0631244 21.0378 0.0308319 21.6818C0.124788 22.3257 0.447407 22.9144 0.939694 23.3401C1.43198 23.7657 2.06104 24 2.71184 24C3.36265 24 3.99171 23.7657 4.484 23.3401C4.97628 22.9144 5.2989 22.3257 5.39286 21.6818C5.48681 21.0378 5.34583 20.3815 4.99569 19.8329C4.64554 19.2843 4.10963 18.8801 3.48596 18.6941ZM24 2.71064C24.0002 2.2081 23.8607 1.71541 23.5969 1.28762C23.3332 0.859841 22.9558 0.513828 22.5067 0.288265C22.0576 0.062701 21.5547 -0.0335245 21.0541 0.0103444C20.5534 0.0542133 20.0749 0.236448 19.6719 0.536677C19.2689 0.836907 18.9573 1.2433 18.7721 1.71043C18.5868 2.17756 18.5351 2.68701 18.6227 3.18185C18.7103 3.67668 18.9338 4.1374 19.2683 4.51249C19.6027 4.88758 20.0349 5.16227 20.5165 5.30585V22.0635C20.5165 22.2688 20.598 22.4657 20.7432 22.6109C20.8884 22.756 21.0853 22.8376 21.2906 22.8376C21.4959 22.8376 21.6928 22.756 21.8379 22.6109C21.9831 22.4657 22.0647 22.2688 22.0647 22.0635V5.30585C22.6233 5.13866 23.1132 4.79595 23.4618 4.3285C23.8104 3.86105 23.9991 3.29375 24 2.71064ZM12.7753 9.40478V1.93652C12.7753 1.73122 12.6938 1.53432 12.5486 1.38914C12.4034 1.24397 12.2065 1.16241 12.0012 1.16241C11.7959 1.16241 11.599 1.24397 11.4538 1.38914C11.3087 1.53432 11.2271 1.73122 11.2271 1.93652V9.40478C10.6681 9.57126 10.1777 9.9138 9.82909 10.3814C9.48044 10.849 9.2921 11.4167 9.2921 12C9.2921 12.5833 9.48044 13.151 9.82909 13.6186C10.1777 14.0862 10.6681 14.4287 11.2271 14.5952V22.0635C11.2271 22.2688 11.3087 22.4657 11.4538 22.6109C11.599 22.756 11.7959 22.8376 12.0012 22.8376C12.2065 22.8376 12.4034 22.756 12.5486 22.6109C12.6938 22.4657 12.7753 22.2688 12.7753 22.0635V14.5952C13.3343 14.4287 13.8247 14.0862 14.1733 13.6186C14.522 13.151 14.7103 12.5833 14.7103 12C14.7103 11.4167 14.522 10.849 14.1733 10.3814C13.8247 9.9138 13.3343 9.57126 12.7753 9.40478Z" fill="#5667FD" />
                  </svg>
                </span>
              </form>
                    <form action="" method="get" class="filter-form-second">
                        <div class="filter-wrapper">
                            <div class="filter-heading-wrapper">
                                <p class="block-heading">Filter</p>
                                <span class="form-closer"><i class="fa-regular fa-xmark-large"></i></span>
                            </div>

                            <!-- Category Filter -->
                            <p class="filter-block-heading">Teglar</p>
                            <select id="categories" class="jquery-multiple filter-input" name="categories" multiple="multiple">
                                {% for category in categories %}
                                    <option value="{{ category.id }}" {% if category.id|stringformat:"s" in selected_categories %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                {% endfor %}
                            </select>

                            <!-- Price Filter -->
                            <p class="filter-block-heading">Narxlar</p>
                            <div class="filter-costs_wrapper">
                                <input type="number" id="staring_cost" name="min_price" value="{{ min_price }}" placeholder="Min price" />
                                <input type="number" id="ending_cost" name="max_price" value="{{ max_price }}" placeholder="Max price" />
                            </div>

                            <!-- Teacher Filter (Gender) -->
                            <p class="filter-block-heading">O'qituvchi</p>
                            <div class="filter-gender-wrapper">
                                {% for teacher in teachers %}
                                    <span class="id_{{ teacher.gender }}">
                                        <input type="radio" name="gender" value="{{ teacher.gender }}" id="id_{{ teacher.gender }}"
                                            {% if teacher.gender == selected_gender %}checked{% endif %} />
                                        <i class="fa-regular fa-{% if teacher.gender == 'Erkak' %}mars{% else %}venus{% endif %}"></i> 
                                        {{ teacher.gender|title }}
                                    </span>
                                {% endfor %}
                            </div>

                            <!-- Days Filter -->
                            <p class="filter-block-heading">Kunlari</p>
                        <div id="days" class="filter-days-wrapper">
                            {% for day in days %}
                                <span class="id_{{ day.name|lower }}">
                                    <input type="checkbox" name="days" value="{{ day.name }}" id="id_{{ day.name|lower }}"
                                        {% if day.name in selected_days %}checked{% endif %} />
                                    {{ day.name }}
                                </span>
                            {% endfor %}
                        </div>

                        <button class="submit-form" type="submit">Saralash</button>
                    </div>
                </form>
              <input type="text" class="searching-input second" placeholder="SAT kurs" />
            </div>
            <div class="course-list">
              {% if courses.exists %}
                  {% for course in courses %}
                      <a href="#" class="course-item">
                          <div class="course-item-wrapper">
                              <img src="{{ course.edu_center.logo.url }}" alt="" />
                              <div class="course-item-text">
                                  <h1 class="course-item-title">{{ course.name }}</h1>
                                  <p class="course-item-level">{{ course.level.name }}</p>
                                  <p class="course-item-days-little">
                                      {% for day in course.days.all %}
                                          {{ day.name }}{% if not forloop.last %}, {% endif %}
                                      {% endfor %}
                                  </p>
                              </div>
                          </div>
                          <div class="course-item-days">
                              {% for day in course.days.all %}
                                  <div class="course-item-day {% if day.name == 'Har kuni' %} everyday {% endif %}">{{ day.name }}</div>
                              {% endfor %}
                              {% if course.intensive %}
                                  <div class="course-item-day intensive">
                                      Intensiv <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f525/512.webp" alt="Intensive" />
                                  </div>
                              {% endif %}
                              <div class="course-item-time">{{ course.start_time|date:'H:i' }}</div>
                          </div>
                      </a>
                  {% endfor %}
              {% else %}
                  <p>Kurslar topilmadi</p>
              {% endif %}
          </div>
          </div>
        </div>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
  <script>
  
   // for search 

document.addEventListener('DOMContentLoaded', function () {
    const searchForm = document.querySelector('.blocky-form');
    const searchInput = searchForm.querySelector('.searching-input');
    const resultsContainer = document.querySelector('.course-list'); 

    searchForm.addEventListener('submit', function (e) {
        e.preventDefault();
    });

    searchInput.addEventListener('keyup', function () {
        const query = searchInput.value;

        if (query.length >= 2) {
            fetch(`/search-course/?q=${query}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = '';
                let resultsHtml = '';

                if (data.courses.length > 0) {
                    data.courses.forEach(course => {
                        resultsHtml += `
                            <a href="#" class="course-item">
                                <div class="course-item-wrapper">
                                    <img src="${course.edu_center_logo}" alt="${course.name} logo" />
                                    <div class="course-item-text">
                                        <h1 class="course-item-title">${course.name}</h1>
                                        <p class="course-item-level">${course.level_name}</p>
                                        <p class="course-item-days-little">${course.days}</p>
                                    </div>
                                </div>
                                <div class="course-item-days">
                                    ${course.days_html}
                                    ${course.intensive_html ? `<div class="course-item-day intensive">${course.intensive_html}</div>` : ''}
                                    <div class="course-item-time">${course.start_time}</div>
                                </div>
                            </a>
                        `;
                    });
                } else {
                    resultsHtml = '<p>No results found.</p>';
                }
                resultsContainer.innerHTML = resultsHtml;
            })
            .catch(error => {
                console.error('Error fetching search results:', error);
                resultsContainer.innerHTML = '<p>Error fetching data</p>';
            });
        } else {
            resultsContainer.innerHTML = ''; 
        }
    });
});

// others

    $(document).ready(function () {
      $('.jquery-multiple').select2()
    })
    var slider = document.getElementById('slider')
    const starting = document.querySelector('#staring_cost')
    const ending = document.querySelector('#ending_cost')
    
    noUiSlider.create(slider, {
      start: [0, 1000000],
      connect: true,
      range: {
        min: 0,
        max: 1000000
      },
      step: 50000,
      format: {
        to: function (value) {
          return Math.round(value)
        },
        from: function (value) {
          return Number(value)
        }
      }
    })
    
    function updateSliderFromInputs() {
      let startValue = parseInt(starting.value)
      let endValue = parseInt(ending.value)
      if (startValue < 0) startValue = 0
      if (endValue > 5000000) endValue = 5000000
      if (startValue > endValue) startValue = endValue
      slider.noUiSlider.set([startValue, endValue])
    }
    
    slider.noUiSlider.on('update', function (values) {
      starting.value = values[0]
      ending.value = values[1]
    })
    starting.addEventListener('change', updateSliderFromInputs)
    ending.addEventListener('change', updateSliderFromInputs)
  </script>
{% endblock %}
